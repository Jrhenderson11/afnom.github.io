<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Killy the Bit</title>
  <meta name="description" content="BackgroundThis challenge came with the following description:“Killy the Bit is one of the dangerous kittens of the wild west. He alreadyflipped bits in most ...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/bootstrap.css">
  <script src="/js/jquery-1.10.2.min.js"></script>
  <script src="/js/bootstrap.min.js"></script>
  <link rel="canonical" href="http://afnom.net/2014/10/23/13-Killy-the-Bit.html">
  <link rel="alternate" type="application/rss+xml" title="AFiniteNumberOfMonkeys" href="http://afnom.net/feed.xml" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <div class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <a href="http://afnom.net/" class="navbar-brand">AFiniteNumberOfMonkeys</a>
          <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>
        <div class="navbar-collapse collapse" id="navbar-main">
          <ul class="nav navbar-nav navbar-right">
			<li class="dropdown">
			   <a class="dropdown-toggle" data-toggle="dropdown" href="http://afnom.net" id="home">Home <span class="caret"></span></a>
			   <ul class="dropdown-menu" aria-labelledby="home">
			     <li><a href="#who">Who we are</a></li>
			     <li><a href="#meetings">Meetings</a></li>
			     <li><a href="#tools">Tools</a></li>
			     <li><a href="#materials">Learning material</a></li>
			     <li><a href="#contact">Contact</a></li>
			   </ul>
			 </li>
            <li><a href="http://afnom.net/writeups.html">Write-ups</a></li>
          </ul>

        </div>
      </div>
    </div>
</div>

        
          
        
          
        
          
        
          
        
          
        


</header>


    <div class="page-content">
      <div class="container">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Killy the Bit</h1>
    <p class="post-meta">Oct 23, 2014 • Joe Gardiner</p>
  </header>

  <article class="post-content">
    <h2 id="background">Background</h2>

<p>This challenge came with the following description:</p>

<p>“Killy the Bit is one of the dangerous kittens of the wild west. He already
flipped bits in most of the states and recently hacked the Royal Bank of
Fluxembourg. All customer of the bank are now advised to change their password
for the next release of the bank’s website which will be launched on the
23.10.2014 10:01 CEST.</p>

<p>Killy the Bit stands in your debt and sent the following link. Can you break
the password generation process in order to get access to the admin account?”</p>

<p>Following the provided link leads to a single page
(https://wildwildweb.fluxfingers.net:1424/)</p>

<h2 id="page">Page</h2>

<p>The user is then presented with a web page. The page consists of some simple
text, and then a basic form consisting of a single text box and submit button.</p>

<p>The user is asked to submit their username, and their new password will then
be sent to them. If a correct username is enetered, a page with a confirmation
message is displayed, stating that the new password has been sent by email. If
the user enters an incorrect username, the page returns a list of username
that are similar to the provided name.</p>

<p>This page is serviced by a php script, which is provided with the code that
generated the password redacted. The index.phps file can be found
<a href="http://afnom.net/assets/2014/killy-the-bit_index.phps">here</a> (right click -&gt; save as)</p>

<h2 id="sql-injection">SQL Injection</h2>

<p>It was clear after looking at the php file that SQL injection is the key here.
There are two different queries that are used.</p>

<h4 id="query-1">Query 1</h4>

<p>The first query is a simple SELECT query, in which a straightforwad lookup for
the username returns the name and email.</p>

<pre><code>$res = mysql_query("SELECT name,email FROM user where
name='".$_GET['name']."'");
</code></pre>

<p>The script then checks to see if ANY result is returned, and if so the
confirmationmessage is displayed.</p>

<h4 id="query-2">Query 2</h4>

<p>If no result is returned, as second query is performed. This makes use of the
“sound like” operator to find similar usernames</p>

<pre><code>$res = mysql_query("SELECT name,email FROM user where name sounds like '".$_GET['name']."'");
</code></pre>

<p>If any exist, they are printed to the screen, else an error message is
displayed:</p>

<pre><code>while($row = mysql_fetch_object($res)) {
	echo $row-&amp;gt;name;
	echo "&amp;lt;\br&amp;gt;"; ("\" added by me)
}
</code></pre>

<h4 id="attack">Attack</h4>

<p>At first glance, the second query seems to be the one to attack, by somehow
getting the code to print out the passwd column as well(the column name was
revealed in a hint).</p>

<p>One limitation is a line near the top of the file:</p>

<pre><code>if(isset($_GET['name']) &amp;amp;&amp;amp; $_GET['name']!='' &amp;amp;&amp;amp;
!preg_match('/sleep|benchmark|and|or|\||&amp;amp;/i',$_GET['name'])) {
</code></pre>

<p>This line prevents certain strings being passed as parameters. Most
annoyingly, this include <code>and</code> and <code>or</code>, which would be useful here.</p>

<p>A join seems like one solution, but we cannot use this as we can only append
to the current query after the <code>WHERE</code> clause. Therfore, a <code>UNION</code> seems like a
better option.</p>

<p>The first attck string that we tried was as follows:</p>

<pre><code>' UNION SELECT email, passwd AS name FROM user WHERE#
</code></pre>

<p>In theory, this should work, but we kept finding that this attack string
results in Query 1 passing, and Query 2 not being run so there is no scope to
print the passwords. We discovered that we would then need to form some form
of attack string that would cause the first query to fail, but the second to
pass.</p>

<p>This proved difficult. Instead, Chris realised that we could use ther
pass/fail nature of the first query to our advantage to brute force guess the
password.</p>

<p>We made use of the SUBSTR function in SQL to achieve this. If we can match a
substreing of a password to a string provided by us, we could confirm if it
wss correct.</p>

<p>We tested this with the following attack string:</p>

<pre><code>' UNION SELECT email, passwd FROM user WHERE SUBSTR(passwd,1,5)='flag{'#
</code></pre>

<p>We used this as an intial guess as in all of the challenges we had completed,
the flag beings with “flag{“. Inputting this into the username box resulted in
the confirmation screen! We then manually tried to guess the next letter by
brute force, and it revealed th enext letter was k.</p>

<p>Obviously the flag could contain any character, so me and Chris simultaneously
worked on our own scripts to do this manually. My script was writted in Java,
Chris’ in Perl. The Java script made a request to the challenge domain, with a
constructed GET request. The key line was: </p>

<pre><code>url = new URL("https://wildwildweb.fluxfingers.net:1424/?name=%27+UNION+SELECT+email%2C+passwd+FROM+user+WHERE+SUBSTR%28passwd%2C" + pos + "%2C1%29%%27" + look + "%27%23&amp;amp;submit;=Generate#");
</code></pre>

<p>(This is now slightly incorrect but you get the idea:))</p>

<p>The response was then parsed to look for the key string “A new password was
generated”, if this was found the current letter was added to the flag. The
request included the previosuly found letters at each step.</p>

<p>This worked fine, and we found the partial flag
<code>flag{killy_the_bit_is_wanted_fo</code>. The script then stopped working at this
step, and we were confused as to why. EWe guessed the next letter was R, but
maually trying this resulted in the php code not even being run. We soon
realised the issue. When the “r” is tried, the regular expression matcher the
“or” of the “for”, and rejects the request! So we then had to guess the rest
of the password ingoring the first half. This resulted in the full flag:</p>

<pre><code>flag{killy_the_bit_is_wanted_for_9000_$$_for_flipping_bits}
</code></pre>

<p>Chris was the first to get the full flag by seconds. But this was not accepted
by the form. We suspected that it was an issue with capitilisation. The
problem is that in SQL, the = operator is case-insensitive, meaning that we
cannot match the exact capitilaisation using this. We then remembered the
ImageUpload challenge, where we used thr ASCII operator to fetch the passord.
We then modified out attack string to resemble:</p>

<pre><code>' UNION SELECT email, passwd FROM user WHERE ASCII(SUBSTR(passwd,32,1))=ASCII('r')#1
</code></pre>

<p>This checks that the 32nd character is a lower case r, and only returns a
result if so. We modified the script to check individual characters, and soon
found the capitalisation for the 15th character onwards. For the first 15
characters, the request matched a different password in the table, so we had
to manually guess the capitilisation for these (which I got first time). The
final flag was:</p>

<pre><code>flag{Killy_the_Bit_Is_Wanted_for_9000_$$_FoR_FlipPing_Bits}
</code></pre>

<p>In this step, the Java script won the race. The Java script can be found
<a href="http://afnom.net/assets/2014/killy-the-bit_URLFetcher.java">here</a>.</p>

<p>A later hint by the admins stated that a single query can return the password
and brute forcing is not necessary, but we were still pleased to solve this
challenge. Overall it was a nice challenge to complete even though at first it
seemed a lot easier than it actually was.</p>

<p>This challenge was largely completed as a joint effort by myself and Chris
Novakovic (csn), who was working remotely. Also involved on site were Tom
Chothia and Jiangshan Yu who were valuable in solving this challenge, which
earned us 200 points plus 70 bonus points.</p>


  </article>

</div>

      </div>
    </div>

    <hr>
<footer class="site-footer">

  <div class="container">

    <div class="row">
      <div class="col-lg-12">

       
        <p><p>Copyright &copy; University of Birmingham 2014</p></p>

      </div>
    </div>

  </div>

</footer>


  </body>

</html>
