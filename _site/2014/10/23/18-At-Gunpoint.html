<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>At Gunpoint</title>
  <meta name="description" content="Category: Reversing">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/bootstrap.css">
  <script src="/js/jquery-1.10.2.min.js"></script>
  <script src="/js/bootstrap.min.js"></script>
  <link rel="canonical" href="http://afnom.net/2014/10/23/18-At-Gunpoint.html">
  <link rel="alternate" type="application/rss+xml" title="AFiniteNumberOfMonkeys" href="http://afnom.net/feed.xml" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <div class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <a href="http://afnom.net/" class="navbar-brand">AFiniteNumberOfMonkeys</a>
          <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>
        <div class="navbar-collapse collapse" id="navbar-main">
          <ul class="nav navbar-nav navbar-right">
			<li class="dropdown">
			   <a class="dropdown-toggle" data-toggle="dropdown" href="http://afnom.net" id="home">Home <span class="caret"></span></a>
			   <ul class="dropdown-menu" aria-labelledby="home">
			     <li><a href="http://afnom.net/#who">Who we are</a></li>
			     <li><a href="http://afnom.net/#meetings">Meetings</a></li>
			     <li><a href="http://afnom.net/#tools">Tools</a></li>
			     <li><a href="http://afnom.net/#materials">Learning material</a></li>
			     <li><a href="http://afnom.net/#contact">Contact</a></li>
			   </ul>
			 </li>
            <li><a href="http://afnom.net/writeups.html">Write-ups</a></li>
          </ul>

        </div>
      </div>
    </div>
</div>

        
          
        
          
        
          
        
          
        
          
        


</header>


    <div class="page-content">
      <div class="container">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">At Gunpoint</h1>
    <p class="post-meta">Oct 23, 2014 • Piotr Kordy</p>
  </header>

  <article class="post-content">
    <p><em>Category:</em> Reversing</p>

<p><em>Points:</em> 200</p>

<p><em>Author:</em> freddy</p>

<p><em>Description:</em></p>

<p>You’re the sheriff of a small town, investigating news about a gangster squad
passing by. Rumor has it they’re easy to outsmart, so you have just followed one
to their encampment by the river. You know you can easily take them out one by
one, if you would just know their secret handshake..</p>

<p>Download:
<a href="http://afnom.net/assets/2014/gunpoint_2daf5fe3fb236b398ff9e5705a058a7f.dat" title="file">gunpoint_2daf5fe3fb236b398ff9e5705a058a7f.dat</a></p>

<h2 id="write-up">Write-up</h2>

<pre><code>$file gunpoint_2daf5fe3fb236b398ff9e5705a058a7f.dat
gunpoint_2daf5fe3fb236b398ff9e5705a058a7f.dat: Gameboy ROM: "FLUX", [ROM ONLY], ROM: 256Kbit
</code></pre>

<p>Nice, a gameboy ROM. Searching for <code>gameboy emulator</code> gets us
<a href="http://sourceforge.net/projects/vba/">Visual Boy Advance</a> as the first result. We need to
change the extension to <code>gbc</code> to be able to open the file in the emulator.
After running the game for some time or doing <code>options-&gt;emulator-&gt;speed up
toggle</code>, we get:</p>

<p><img src="/http://afnom.net/assets/2014/gunpoint_screen.png" alt="Gameboy Screen" /></p>

<p>So probably we need to guess the secret key combination. Fortunately emulator
has also dissasembler and IDA is also able to dissaseble the code.
<a href="http://www.opusgames.com/games/GBDev/zips/Gbspec.txt">Here</a> is some thorough
description of Gameboy hardware. The most interesting part is here:</p>

<pre><code>FF00
	Name     - P1
	Contents - Register for reading joy pad info
          and determining system type.    (R/W)
		  
       Bit 7 - Not used
       Bit 6 - Not used
       Bit 5 - P15 out port
       Bit 4 - P14 out port
       Bit 3 - P13 in port
       Bit 2 - P12 in port
       Bit 1 - P11 in port
       Bit 0 - P10 in port
	   
     This is the matrix layout for register $FF00:
	 
	 
             P14        P15
              |          |
    P10-------O-Right----O-A
              |          |
    P11-------O-Left-----O-B
              |          |
    P12-------O-Up-------O-Select
              |          |
    P13-------O-Down-----O-Start
              |          |
			  
   Example code:
   
      Game: Ms. Pacman
      Address: $3b1
	  
    LD A,$20       &lt;- bit 5 = $20
    LD ($FF00),A   &lt;- select P14 by setting it low
    LD A,($FF00)
    LD A,($FF00)   &lt;- wait a few cycles
    CPL            &lt;- complement A
    AND $0F        &lt;- get only first 4 bits
    SWAP A         &lt;- swap it
    LD B,A         &lt;- store A in B
    LD A,$10
    LD ($FF00),A   &lt;- select P15 by setting it low
    LD A,($FF00)
    LD A,($FF00)
    LD A,($FF00)
    LD A,($FF00)
    LD A,($FF00)
    LD A,($FF00)   &lt;- Wait a few MORE cycles
    CPL            &lt;- complement (invert)
    AND $0F        &lt;- get first 4 bits
    OR B           &lt;- put A and B together
	
    LD B,A         &lt;- store A in D
    LD A,($FF8B)   &lt;- read old joy data from ram
    XOR B          &lt;- toggle w/current button bit
    AND B          &lt;- get current button bit back
    LD ($FF8C),A   &lt;- save in new Joydata storage
    LD A,B         &lt;- put original value in A
    LD ($FF8B),A   &lt;- store it as old joy data
	
	
    LD A,$30       &lt;- deselect P14 and P15
    LD ($FF00),A   &lt;- RESET Joypad
    RET            &lt;- Return from Subroutine
	
      The button values using the above method are such:
      $80 - Start             $8 - Down
      $40 - Select            $4 - Up
      $20 - B                 $2 - Left
      $10 - A                 $1 - Right
	  
      Let's say we held down A, Start, and Up.
      The value returned in accumulator A would be $94
</code></pre>

<p>If we go to <code>Tools-&gt;Dissasemble</code> then we have a fairly good chance we land up in
the code that is almost the same. (If not press <code>Next</code> few times) We can see
that the result of the key presses are stored in addresses <code>C0A1</code> and <code>C0A2</code>.
Counter at address <code>C0A0</code> is increased each time we press the correct key. Using
<code>Tools-&gt;Memory viewer</code> we can see when we press the correct key. The sequence is 
<code>up, left, down, right, up, left, down, right, B, B A, A</code>. </p>

<p><em>Flag</em> is tkCXDJheQDNRN </p>

<h3 id="other-write-ups-and-resources">Other write-ups and resources</h3>

<ul>
  <li><a href="http://tasteless.se/2014/10/hack-lu-ctf-2014-at-gunpoint/" title="tasteless">Write-up by tasteless</a></li>
</ul>


  </article>

</div>

      </div>
    </div>

    <hr>
<footer class="site-footer">

  <div class="container">

    <div class="row">
      <div class="col-lg-12">

       
        <p><p>Copyright &copy; University of Birmingham 2014</p></p>

      </div>
    </div>

  </div>

</footer>


  </body>

</html>
