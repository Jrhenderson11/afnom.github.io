<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.9" />
<title>Hack.lu CTF 2014: At Gunpoint</title>
<!---- <link href='http://afnom.net/css/wiki.css' rel='stylesheet' type='text/css'>

<script src="http://afnom.net/js/wiki.js">
</script> ---->
<link rel="stylesheet" href="http://markable.in/site_media/static/bootstrap/css/bootstrap.min.css">
</script>
<style>
body {
	margin:2em 2em 2em 2em
}
</style>
</head>

<body class="article">
<div id="header">
<h1>Hack.lu CTF 2014: At Gunpoint</h1>
<span id="author">Piotr Kordy</span><br />
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p><strong>Category:</strong> Reversing <br />
<strong>Points:</strong> 200 <br />
<strong>Author:</strong> freddy</p></div>
<div class="paragraph"><p><strong>Description:</strong></p></div>
<div class="paragraph"><p>You&#8217;re the sheriff of a small town, investigating news about a gangster squad
passing by. Rumor has it they&#8217;re easy to outsmart, so you have just followed one
to their encampment by the river. You know you can easily take them out one by
one, if you would just know their secret handshake..</p></div>
<div class="paragraph"><p>Download:
<a href="gunpoint_2daf5fe3fb236b398ff9e5705a058a7f.dat">gunpoint_2daf5fe3fb236b398ff9e5705a058a7f.dat</a></p></div>
<hr />
</div>
</div>
<div class="sect1">
<h2 id="_write_up">Write-up</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre><code>$file gunpoint_2daf5fe3fb236b398ff9e5705a058a7f.dat
gunpoint_2daf5fe3fb236b398ff9e5705a058a7f.dat: Gameboy ROM: "FLUX", [ROM ONLY], ROM: 256Kbit</code></pre>
</div></div>
<div class="paragraph"><p>Nice, a gameboy ROM. Searching for <code>gameboy emulator</code> gets us
<a href="http://sourceforge.net/projects/vba/">Visual Boy Advance</a> as the first result. We need to
change the extension to <code>gbc</code> to be able to open the file in the emulator.
After running the game for some time or doing <code>options-&gt;emulator-&gt;speed up
toggle</code>, we get:</p></div>
<div class="imageblock">
<div class="content">
<img src="screen.png" alt="[Game screenshot]" />
</div>
</div>
<div class="paragraph"><p>So probably we need to guess the secret key combination. Fortunately emulator
has also dissasembler and IDA is also able to dissaseble the code.
<a href="http://www.opusgames.com/games/GBDev/zips/Gbspec.txt">Here</a> is some thorough
description of Gameboy hardware. The most interesting part is here:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>FF00
   Name     - P1
   Contents - Register for reading joy pad info
              and determining system type.    (R/W)

           Bit 7 - Not used
           Bit 6 - Not used
           Bit 5 - P15 out port
           Bit 4 - P14 out port
           Bit 3 - P13 in port
           Bit 2 - P12 in port
           Bit 1 - P11 in port
           Bit 0 - P10 in port

         This is the matrix layout for register $FF00:


                 P14        P15
                  |          |
        P10-------O-Right----O-A
                  |          |
        P11-------O-Left-----O-B
                  |          |
        P12-------O-Up-------O-Select
                  |          |
        P13-------O-Down-----O-Start
                  |          |

       Example code:

          Game: Ms. Pacman
          Address: $3b1

        LD A,$20       &lt;- bit 5 = $20
        LD ($FF00),A   &lt;- select P14 by setting it low
        LD A,($FF00)
        LD A,($FF00)   &lt;- wait a few cycles
        CPL            &lt;- complement A
        AND $0F        &lt;- get only first 4 bits
        SWAP A         &lt;- swap it
        LD B,A         &lt;- store A in B
        LD A,$10
        LD ($FF00),A   &lt;- select P15 by setting it low
        LD A,($FF00)
        LD A,($FF00)
        LD A,($FF00)
        LD A,($FF00)
        LD A,($FF00)
        LD A,($FF00)   &lt;- Wait a few MORE cycles
        CPL            &lt;- complement (invert)
        AND $0F        &lt;- get first 4 bits
        OR B           &lt;- put A and B together

        LD B,A         &lt;- store A in D
        LD A,($FF8B)   &lt;- read old joy data from ram
        XOR B          &lt;- toggle w/current button bit
        AND B          &lt;- get current button bit back
        LD ($FF8C),A   &lt;- save in new Joydata storage
        LD A,B         &lt;- put original value in A
        LD ($FF8B),A   &lt;- store it as old joy data


        LD A,$30       &lt;- deselect P14 and P15
        LD ($FF00),A   &lt;- RESET Joypad
        RET            &lt;- Return from Subroutine

          The button values using the above method are such:
          $80 - Start             $8 - Down
          $40 - Select            $4 - Up
          $20 - B                 $2 - Left
          $10 - A                 $1 - Right

          Let's say we held down A, Start, and Up.
          The value returned in accumulator A would be $94</code></pre>
</div></div>
<div class="paragraph"><p>If we go to <code>Tools-&gt;Dissasemble</code> then we have a fairly good chance we land up in
the code that is almost the same. (If not press <code>Next</code> few times) We can see
that the result of the key presses are stored in addresses <code>C0A1</code> and <code>C0A2</code>.
Counter at address <code>C0A0</code> is increased each time we press the correct key. Using
<code>Tools-&gt;Memory viewer</code> we can see when we press the correct key. The sequence is
<code>up, left, down, right, up, left, down, right, B, B A, A</code>.</p></div>
<div class="paragraph"><p><strong>Flag</strong> is tkCXDJheQDNRN</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_other_write_ups_and_resources">Other write-ups and resources</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
<a href="http://tasteless.se/2014/10/hack-lu-ctf-2014-at-gunpoint/">Write-up by tasteless</a>
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated
 2014-10-23 18:00:07 BST
</div>
</div>
</body>
</html>
